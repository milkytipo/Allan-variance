% clc;    %清空命令行窗口
clear;  %清空工作区
close all;

% % ――――SBG读取――――%
% fid1= fopen('IG-500N_007000927.txt');
% head= textscan(fid1, '%s', 1, 'delimiter', '\n');  %读取文件头
% rawSBG =textscan(fid1,'%*f %*f %*f %*f %*f %*f %f %f %f  %*[^\n]');  
% data1=cell2mat(rawSBG (1,1)) ;
% data2=cell2mat(rawSBG (1,2)) ;
% data3=cell2mat(rawSBG (1,3)) ;
% data=[data1,data2,data3];
% data = data( 1:36000,:)*3600;                           %SBG   截取两个小时的数据，把 deg/s 转为 deg/h

% % ――――手机读取――――%
fid= fopen('acc2.txt');
rawphone =textscan(fid,'%s %s %f %f %f');  
data1=cell2mat(rawphone (1,3)) ;
data2=cell2mat(rawphone (1,4)) ;
data3=cell2mat(rawphone (1,5)) ;
data=[data1,data2,data3];
varA =sqrt( var(data1)^2+var(data2)^2+var(data3) ^2);
varx=sqrt(var(data1));
vary=sqrt(var(data2));
varz=sqrt(var(data3));
% data = data( 1:36000,:)*57.29578*3600;    %手机   截取两个小时的数据，把 radian/s 转为 deg/h
data = data( 1:36000,:)*3600;    %手机   截取两个小时的数据，把 deg/s 转为 deg/h
data = data -mean(data);


%――――求解――――%
[T, sigma2] = allan(data,5, 100);     %求Allan标准差，用100个点来描述
loglog(T, sigma2, 'o');                  %画双对数坐标图
xlabel('time(sec)');                 %添加x轴标签
ylabel('Sigma(deg/h)');              %添加y轴标签
legend('X axis','Y axis','Z axis'); %添加标注
grid on;                            %添加网格线
hold on;                            %使图像不被覆盖



%――――拟合――――%                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% 有两种方法，第一种是最小二乘拟合，第二种是泰勒展开拟合，事实证明，第一种拟合效果好
%直接最小二乘拟合
C(1, :) = y_fit((T'), sigma2(:, 1)', 2)';   %拟合
C(2, :) = y_fit((T'), sigma2(:, 2)', 2)';
C(3, :) =  y_fit((T'), sigma2(:, 3)', 2)';

Q = abs(sqrt (C(:, 1))) /( sqrt(3) );         %量化噪声，单位：arcsec   //abs:实部和虚部的算术平方根
N = abs(sqrt(C(:, 2))) / 60;	            %角度随机游走，单位：deg/h^0.5
Bs = abs(sqrt(C(:, 3)) )/ 0.6643;	        %零偏不稳定性，单位：deg/h
K = abs(sqrt(C(:, 4)) )* sqrt(3) * 60;	%角速率游走，单位：deg/h/h^0.5
R = abs(sqrt(C(:, 5))) * sqrt(2) * 3600;	%速率斜坡，单位：deg/h/h

fprintf('量化噪声      X轴：%f Y轴：%f Z轴：%f  单位：arcsec\n', Q(1), Q(2), Q(3));
fprintf('角度随机游走  X轴：%f Y轴：%f Z轴：%f  单位：deg/h^0.5\n', N(1), N(2), N(3));
fprintf('零偏不稳定性  X轴：%f Y轴：%f Z轴：%f  单位：deg/h\n', Bs(1), Bs(2), Bs(3));
fprintf('角速率游走    X轴：%f Y轴：%f Z轴：%f  单位：deg/h/h^0.5\n', K(1), K(2), K(3));
fprintf('速率斜坡      X轴：%f Y轴：%f Z轴：%f  单位：deg/h/h\n', R(1), R(2), R(3));

D(:, 1) = C(1, 1)*(T).^(-2) + C(1, 2)*(T).^(-1) + C(1, 3)*(T).^(0) + C(1, 4)*(T).^(1) + C(1, 5)*(T).^(2);    %生成拟合函数
D(:, 2) = C(2, 1)*(T).^(-2) + C(2, 2)*(T).^(-1) + C(2, 3)*(T).^(0) + C(2, 4)*(T).^(1) + C(2, 5)*(T).^(2);
D(:, 3) = C(3, 1)*(T).^(-2) + C(3, 2)*(T).^(-1) + C(3, 3)*(T).^(0) + C(3, 4)*(T).^(1) + C(3, 5)*(T).^(2);

loglog(T, D);   %画双对数坐标图

% %泰勒展开+最小二乘拟合  //此部分拟合需要把sigma2 变成sigma
% C(1, :) = y_fit(sqrt(T'), sigma(:, 1)', 2)';   %拟合
% C(2, :) = y_fit(sqrt(T'), sigma(:, 2)', 2)';
% C(3, :) =  y_fit(sqrt(T'), sigma(:, 3)', 2)';
% 
% Q = abs(C(:, 1)) / sqrt(3);         %量化噪声，单位：arcsec   //abs:实部和虚部的算术平方根
% N = abs(C(:, 2)) / 60;	            %角度随机游走，单位：deg/h^0.5
% Bs = abs(C(:, 3)) / 0.6643;	        %零偏不稳定性，单位：deg/h
% K = abs(C(:, 4)) * sqrt(3) * 60;	%角速率游走，单位：deg/h/h^0.5
% R = abs(C(:, 5)) * sqrt(2) * 3600;	%速率斜坡，单位：deg/h/h
% 
% fprintf('量化噪声      X轴：%f Y轴：%f Z轴：%f  单位：arcsec\n', Q(1), Q(2), Q(3));
% fprintf('角度随机游走  X轴：%f Y轴：%f Z轴：%f  单位：deg/h^0.5\n', N(1), N(2), N(3));
% fprintf('零偏不稳定性  X轴：%f Y轴：%f Z轴：%f  单位：deg/h\n', Bs(1), Bs(2), Bs(3));
% fprintf('角速率游走    X轴：%f Y轴：%f Z轴：%f  单位：deg/h/h^0.5\n', K(1), K(2), K(3));
% fprintf('速率斜坡      X轴：%f Y轴：%f Z轴：%f  单位：deg/h/h\n', R(1), R(2), R(3));
% 
% D(:, 1) = C(1, 1)*sqrt(T).^(-2) + C(1, 2)*sqrt(T).^(-1) + C(1, 3)*sqrt(T).^(0) + C(1, 4)*sqrt(T).^(1) + C(1, 5)*sqrt(T).^(2);    %生成拟合函数
% D(:, 2) = C(2, 1)*sqrt(T).^(-2) + C(2, 2)*sqrt(T).^(-1) + C(2, 3)*sqrt(T).^(0) + C(2, 4)*sqrt(T).^(1) + C(2, 5)*sqrt(T).^(2);
% D(:, 3) = C(3, 1)*sqrt(T).^(-2) + C(3, 2)*sqrt(T).^(-1) + C(3, 3)*sqrt(T).^(0) + C(3, 4)*sqrt(T).^(1) + C(3, 5)*sqrt(T).^(2);
% loglog(T, D);   %画双对数坐标图
  